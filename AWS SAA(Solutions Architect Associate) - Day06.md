# 24/7/16 AWS SAA(Solutions Architect Associate) - Day06

## Amazon S3

### 1. Amazon S3, S3 보안, CloudFront

#### 이벤트 알림

- 객체가 생성되거나 삭제,복구,복제 등을 이벤트라고함
- 필터링 가능 (ex. jpg로 끝나는 객체만 고려)
- 이벤트로 자동으로 반응 -> SNS,SQS, Lamdafunction
- 원하는 만큼 S3 이벤트 생성 가능
- 통상적으로 몇초~ 몇분안에 대상에게 전달

- IAM 권한 혹은 대상 리소스 액세스 정책을 정의
- 모든 이벤트들은 Amazon EventBridge에 감
  - 규칙도 설정 가능
  - 많은 고급 필터링 옵션을 설정 가능

#### S3 퍼포먼스

- 기준 성능
  - 기본적으로 요청이 아주 많을때 자동으로 확장
  - 지연시간도 100~200ms
  - 버킷내에서 접두사당 초당 3,500개의 PUT/COPY/POST/DELETE
  - 초당 5,500개의 GET/HEAD
  - 간단하게 말하면 고성능
- 성능, 최적화
  - 멀치파트 업로드
    - 100MG 넘는것을 추천
    - 5GB초과는 무조건 사용
    - 전송속도를 높여 대역폭을 최대화 가능
  - S3 전송 가속화
    - 파일을 AWS 엣지 로케이션으로 전송해서 전송 속도를 높이고 데이터를 대상 리전에 있는 S3로 보냄
    - 멀티파트 업로드랑 같이 사용 가능
  - S3 바이터 범위 가져오기
    - 파일에서 특정 바이트 범위를 가져와서 GET 요청을 병렬화
    - 특정 바이트범위를 가져오는데 실패한 경우에도 복원이 쉽다
    - 다운로드 속도를 높일 때 사용 혹은 파일 일부만 검색

#### S3 Select & Glacier Select

- SQL문에서 간단히 행과 열을 사용해 S3안에 파일 검색을 필터링
- 네트워크전송이 줄어들기때문에 데이터 검색과 필터링에 드는 클라이언트측의 CPU비용도 줄어듬

#### S3 Batch Operations

- 단일 요청으로 기존 S3 객체에서 대량 작업을 수행하는 서비스
  - 한번에 많은 S3 객체의 메타데이터와 프로퍼티 수정 가능
  - S3 버킷 간에 객체 복사 가능
  - S3 버킷 내 암호화되지 않은 모든 객체를 암호화 가능
  - ACL이나 태그 수정 가능
  - S3 Glacier에서 한 번에 많은 객체 복원 가능
  - Lambda 함수 호출, S3 Batch Operation에서 사용자 지정 작업을 수행도 가능
- 작업은 객체의 목록, 수행할 작업 옵션 매개 변수로 구성
- 재시도를 관리, 진행상황 추측 , 작업 완료 알림, 보고서 작성 가능
- S3 Inventory라는 기능을 사용해 객체 목록을 가져오고 S3 SELECT를 사용, 객체를 필터링

- 주요 사용사례는 S3 Inventory를 사용해 암호화되지 않은 모든 객체를 찾은 다음 S3 Batch Operations를 사용해 한 번에 모두 암호화

#### S3 - Storage Lens

- 전체 AWS 조직에서 스토리지를 이해하고, 분석, 최적화하는데 도움이 되는 서비스
- 이상징후 발견, 비용 효율성 파악, 전체 AWS 조직에 보호 모범 사례를 적용 가능(30일 사용량 및 활동 메트릭이 제공)
- 조직 수준에서 또는 특정 계정, 지역, 버킷 또는 접두사별로도 데이터를 집계 가능
- 나만의 대시보드 만들수도있고, csv형식과같은 형식으로 볼 수 있음
- 기본 대시보드
  - 무료 및 고급 지표에 대한 요약된 인사이트와 트렌드 확인 가능
  - 여러 지역과 여러 계정의 데이터가 표시
  - S3에서 사전 구성
  - 삭제X, 비활성화 가능

- 메트릭 (지표)
  - 요약 메트릭(지표)
    - 일반적인 인사이트를 제공
    - 스토리지 바이트
    - 사용사례 : 가장 빠르게 성장하거나, 사용하지 않는 버킷과 접두사를 식별
  - 비용 최적화 지표
    - 스토리지 비용을 관리하고 최적화할 수 잇는 인사이트를 제공
    - 현재 버전이 아닌 버전의 정보 제공
    - 사용사례 : 어떤 버킷이 다중 파트 업로드에 실패했는지, 또는 어떤 객체를 더 저렴한 스토리지 클래스로 전환 할수있는지 확인
  - 데이터 보호 메트릭
    - 데이터 보호 기능에 대한 인사이트를 제공
    - VesioningEnabledBucketCount를 통해 버전관리 등을 통해 활성화 
    - 사용사례 : 데이터 보호 모범 사례를 따르지 않는 버킷을 식별
  - 액세스 관리 메트릭
    - S3버킷 소유권에 대한 인사이트를 제공
    - 사용사례 : 버킷이 현재 어떤 객체 소유권 설정을 사용하고있는지 식별
  - 이벤트 메트릭
    - s3 이벤트 알림에 대한 인사이트를 얻고 s3 이벤트 알림이 구성된 버킷의 수를 파악
  - 퍼포먼스 메트릭
    - s3 전송 가속에 대한 인사이트를 얻고 s3 전송 가속이 활성화된 버킷의 수를 확인
  - 액티비티 메트릭
    - request에 대한 인사이트 제공
  - 상세 상황 코드 메트릭
    - http 상태 코드에 대한 인사이트 제공

- 무료 렌즈 vs 유료 렌즈
  - 무료
    - 자동으로 제공 
    - 28개의 사용량 지표가 포함
    - 14일 조회가능
    - 추가 유료 지표 및 기능 사용 가능

### 2. S3 보안

#### S3 객체 암호화

- 서버 측 암호화 (SSE)
  - SSE-S3 
    - 아마존에서 관리 기본값으로 형성
    - AWS에 의해 서버측에서 암호화
    - 암호화 보안 유형은 ASE-256
    - 헤더를 "x-amz-server-side-encryption":"AES256" 을 세팅 필수
  - SSE KMS 
    - KMS키를 이요하여 암호화
    - 키관리 서비스를 이용해서 직접 자신의 키를 관리
    - 사용자가 키를 통제할 수 있는게 장점
    - CloudTrail을 이용해서 키 사용 검사 가능
    - 헤더를 "x-amz-server-side-encryption":"aws:kms" 을 세팅 필수
    - 제한사항 존재
      - 업로드 후 다운로드 할때 KMS사용해야함
      - 예를 들어 GenerateDataKey같은 api
      - Decrypt API를 사용해서 복호화함
      - 리전에따라 초당 5천내지 3만건의 요청 가능
  - SSE-C
    - 고객이 제공한 키를 사용
    - 키가 외부에서 관리되지만여전히 서버사이드 암호
    - 암호화키를 저장 x 폐기
    - htts를 사용해야만함
    - 헤더 일부로서 키를 전달해야함
- 클라이언트 측 암호화
  - 클라이언트 측의 모든 걸 암호화한 다음에 S3에 업로드
  - 클라이언트 라이브러리를 활용하면 더 쉽게 구현가능
  - 클라이언트가 직접 데이터를 암호화한 다음에 s3에 전송한다는 개념
  - 복호화는 외부 클라이언트 측에서 이뤄짐

- 전송 중 암호화 또는 통신 중 암호화(SSL/TLS)
  - Endpoint
    - HTTP 
    - HTTPS
      - 권고
      - SSE-C라면 무조건
  - 버킷에 버킷정책을 첨부하면 암호화 강제 가능

#### S3 기본 암호화

- 기본값으로 버킷은 SSE-S3 암호화
- 다른 암호 (KMS)로 기본 암호화 변경 가능
- 또는 버킷 정책을 이용해서 암호화를 강제

#### CORS

- Cross-Origin Resource Sharing (CORS)
- 오리진 = 체계(프로토콜) + host(도메인)+포트로 구성
- CORS는 웹 브라우저 기반 보안 매커니즘 
- Same Origin : http://example.com/app1 & http://example.com/app2
- Different origins : http://www.example.com & http://other.example.com
- 다른 오리진이 CORS헤더를 사용해서 요청을 허용하지 않는 한 해당 요청은 이용 X

- S3에버킷에서 교차 오리진 요청을하면 정환한 CORS헤더를 활성화

#### MFA delete

- 멀티팩터 인증을 의미
  - 사용자가 장치에서 코드를 생성하도록 강제
  - Google Authenticator 애플리케이션이 설치된 휴대폰이나 MFA 하드웨어 장치
- 객체 버전을 영구 삭제할때 필요
  - 영구 삭제에 대한 보호 설정
  - 버킷에서 버저닝을 중단할때도 필요
- 버저닝을 활성화하거나 삭제된 버전을 나열하는 작업은 굳이 필요 X
- 버킷에서 버저닝 활성화 해야함
- 루트 계정만이 MFA Delete를 활성화 하거나 비활성화 할 수 있음

#### S3 액세스 로그

- 감사 목적으로 S3 버킷에 대한 모든 액세스를 기록 가능
- 어떤 계정에서든 S3로 보낸 모든 요청은 승인 또는 거부 여부와 상관없이 다른 S3버킷에 파일로 기록
- 데이터는 데이터 분석 도구로 분석 가능
- 대상 로깅 버킷은 같은리전에 있어야함
- 주의사항
  - 로깅 버킷을 모니터링하는 버킷과 동일하게 설정 X
    - 로깅 루프가 무한반복되어 버킷의 크기가 기하급수적으로 증가

#### 미리 서명된 URL

- S3 콘솔, CLI, SDK를 사용하여 생성할 수 있는 URL
- URL 만료기한
  - S3- 최대 12시간
  - CLI -  168시간
- 생성 시, URL을 받는 사용자는 URL을 생성한 사용자의 GET또는 PUT권한을 상속

- 사용 예
  - URL을 동적으로 생성해서 파일을 다운로드 할수있게함
  - 일시적으로 사용자가 S3 버킷의 특정한 위치에 파일을 업로드도 가능

#### S3 Glacier 볼트 잠금

- WORM(한 번 쓰고 여러번 읽는다: Write Once Read many) 모델을 채용하기 위해 Glacier 볼트를 잠굼

- 수정하거나 삭제할 수 없도록 잠금
- Glacier 위에 볼트 잠금 정책을 생성
- 편집을 위해 정책을 잠금

#### S3 객체 잠금

- 먼저 비저닝을 활성해야만함
- 이것도 WORM레벨을 지원하려고
- 전체 S3 버킷 수준의 잠금 정책이 아니라 버킷 내의 모든 객체에 각각 적용할 수 있는 잠금
- 규정 준수 모드
  - S3 Glacier 볼트 잠금과 매우 유사
  - 사용자를 포함한 그 누구도 객체 버전을 덮어쓰거나 삭제 불가
  - 보존 모드 자체도 변경 x
  - 규정 준수를 엄격히 적용할 때 사용
- 거버넌스 보존 모드
  - 대부분의 사용자는 객체 버전을 덮어쓰거나 삭제하거나 로그설정 변경 불가
  - 하지만 관리자같은 일부 사용자는 IAM을 통해 부여받은 특별 권한으로 보존기간을 변경하거나 객체를 바로 삭제 가능
  - 좀더 유연성
- 두가지 모드 모두 보존 기간을 설정 해야만함
- 법적 보존
  - S3 버킷 내 모든 객체를 무기한으로 보호

#### S3 - Access Points

- s3 버킷에 액세스할 다양한 방법을 정의
- 간단하게 보안을 관리할수잇음
- 보안관리를 간소화
- S3 액세스 포인트의 vpc 오리진을 프라이빗 액세스가 가능하도록 저의 가능
- PVC오리진에 액세스하기 위해 액세스포인트에 엑세스하기 위한 VPC엔드포인트라는걸 설정

#### S3 객체 람다

- 사용자가 객체를 받기전에 수정하려고하는 경우
- 액세스 포인트가 필요
- 람다 함수를 사용하면 클라우드에서 아주쉽게 코드를 실행
- 활용 사례
  - 분석기나 비프로덕션 환경을 위해 pii 데이터, 개인식별정보를 삭제하는경우, 혹은 예를들어 데이터 형식을 xml에서 json으로 변환하는경우
  - 즉석에서 이미지 크기를 조정하거나 워터마크를 추가하는 등의 변환

### 3. CloudFront

- 컨텐츠 전송 네트워크 (CDN)을 듯함
- 웹사이트의 컨텐츠를 서로 다른 엣지 로케이션에 미리 캐싱하여 읽기 성능을 높임
- 전세계에 있는 총 216개의 엣지 로케이션을 통해 구성
- DDos 공격에서 보호 받을 수 있음

- Origins
  - S3 버킷
    - cloudFront를 통해 파일을 분산하고 캐싱 가능
    - OAC
    - OAI
    - 클라우드 프론트를 통해 버킷에 데이터 보내는것도 가능
  - Custom Origin (HTTP)
    - 어플맄이션 로드 밸런서
    - EC2 인스턴스
    - S3 웹사이트
    - 그외 다른 HTTP  백엔드
- CloudFront Vs CRR
  - CloudFront
    - 전세계 엣지 네트워크 이용
    - 하루동안 파일들이 캐싱
  - CRR
    - 족제를 원하는 각 리전에 설정이 되어있어야함
    - 전세게를 대상으로 한것 X
    - 파일은 거의 실시간으로 전송
    - 캐싱 X 읽기전용설정만가능

- 지리적 제한 기능
  - 사용자들의 지역에 따라 배포 객체 접근을 제한 가능
    - 접근이 가능한 국가 목록 or 못하는 목록
  - 사용사례
    - 컨텐츠 저작권법으로 인한 제한
- 고급 옵션
  - 요금
    - 전세계에 퍼져있기때문에 엣지 로케이션마다 데이터 전송비용이 다름
    - 가격 등급
      - 비용 절감을위해 전 세계 엣지 로케이션 수 감소 가능
      - 3개 가격 등급
        - Price Class All regions - 최고 성능
        - Price Class 200 : 대부분의 리전 비싼곳 x
        - Price Class 100 : 가장 저렴한 리전만 사용

- Cache Invalidation
  - 백엔드 오리진이 존재 /엣지 로케이션은 우리가 백엔드 오리진을 업데이트 할때 업데이트 사항을 모름, 캐시의 타임 투 리브가 만료되면, 백엔드 오리진으로부터 업데이트된 콘텐츠를 받음
  - 싫으면 전체 또는 일부의 캐시를 강제로 새로고침해서 캐시에 있는 타임 투 리브(TTL)를 모두 제거 가능
  - 이때 틀정 파일 경로를 전달 해야 함 (\*, /images/* )

#### Global Accelerator

- 글로벌 사용자들이 직접 접근 할때 애플리케이션이 한 리전에 배치되어 있다면 로드밸런서로 라우팅을 해도 거치는 동안에 수 많은 홉으로 인해 상당한 지연이 발생할 수 있다.
- 지연시간을 최소화 하기위해 최대한 빨리 AWS 네트워크를 통하기 위해 Global Accelerator 사용

- Unicast IP vs Anycast IP
  - Unicast IP : 하나의 서버가 하나의 IP주소를 가집니다.
  - Anycast ip : 모든서버가 동일한 ip를 가지고 클라이언트가 가장 가까운곳으로 연결
- 글로벌 액셀러레이터는 이 애니캐스트 IP개념을 사용
- AWS네트워크를 거쳐 애플리케이션 로드 밸런서로 트래픽을 전송
- 탄력적 IP, EC2 인스턴스, 애플리케이션 로드배런서, NLB 함께 WORK
- 지능형 라우팅으로 지연시간이 가장 짧은 엣지 로케이션으로 연결, 뭔가 잘못될 경우에는 신속한 리전 장애 조치가 일어남
- 아무것도 캐시하지 않기에 클라이언트 캐시와도 문제가 X
- 상태확인
  - 애플리케이션이 글로벌 한지 확인
  - 재해 복구에 특히 뛰어남
- 보안
  - 단 두개의 외부 IP만 존재하기 때문에 보안 측면에서도 매우 안전
  - Ddos에도 강함

- Global Accelerator vs CloudFront
  - 둘다 AWS생성한 전 세계의 엣지 로케이션 사용
  - DDoS 보호를 위해 둘 다 AWS Shield와 통합
  - CloudFront
    - 이미지나 비디오 처럼 캐시 가능한 내용과 API 가속 및 동적 사이트 전달 같은 동적 내용 모두에 대해 성능 향상
    - 엣지로케이션으로부터 제공
  - 글로벌 액셀러레이터
    - TCP나 UDP상의 다양한 애플리케이션 성능 향상
    - 패킷은 엣지로케이션으로부터 하나이상의 AWS리전에서 실행되는 애플리케이션으로 프록시 됨
    - 캐싱은 불가능
    - 비HTTP할때 유용
    - 결정적이고 신속한 리전 장애 조치가 필요할때도 좋음

### 4. AWS 스토리지 추가기능

#### AWS Snow Family

- Snow Family는 아주 안전한 휴대기기를 가르킴
- data migration : Snowcone, Snowball Edge, Snowmobile 등
  - 스노우패밀리 사용이유: 네트워크를 통해서 대량의 데이터로 전송하는데 걸리는 시간이 아주김, 대역폭 제한 데이터 전송비용 등의 문제가 발생,대역폭도 공유될수 있음, 연결이 불안할수도 있음
  - 데이터 마이그레이션을 할 수 있게 해주는 오프라인 기기
  - Snowball Edge
    - 물리적 거대한 박스
    - AWS와 거대의용량의 데이터를 교환하기 위해사용
    - 두가지 종류
      - 스토리지가 최적회돤 형태 - 80TB 용량의 하드디스크 용량이 제공
      - 컴퓨팅이 최적화된 형태 - 42TB 또는 28TB
    - 사용사례
      - 대규모 데이터의 클라우드 마이그레이션, 데이터센터 폐지, 또는 재난 복구
    - Snowcone
      - 아주 작은 휴대기기
      - 데이터 양이적은곳 활용
      - 가볍다
      - 두가지 유형
        - Snowcone - 8TB HDD 스토리지가 장착
        - Snowcone SSD - 14TB의 SSD가 장착
      - 공간 제약이 있는 환경 같은경우 사용
      - 배터리 케이블 직접 구해야함
    - 데이터 전송 방법
      - 오프라인으로 데이터 발송
      - 데이터 담은 후 인터넷 연결이 가능할 때 극걸 데이터 센터에 연결
  - Snowmobile
    - 실제 트럭
    - 엑사바이트용량 옮길 수 잇음
  - 사용방법
    - 콘솔에서 기기 배송 요청
    - AWS Opshub 설치
    - Sonowball을 서버에 연결 클라이언트 안에서 파일을 복사
    - 기기 반송
    - 데이터는 S3 버킷에 로딩
- Edge computing : Snowcone, Snowball Edge
  - 활용 사례
    - 데이터 전처리
    - 클라우드로 가지않고 에지에서 이뤄지는 머신러닝
    - 미디어 스트림의 사전 트랜스 코딩
  - 데이터를 다시 aws로 보내야 한다면 기기를 반송
  - 종류
    - Snowcone& Snowcone SSD
      - 2개의 CPU, 4GB의 메모리, 유선 또는 무선 엑세스
      - 전원으로 USB-C나 배터리 옵션이 제공
    - Snowball Edge - 컴퓨팅에 최적화
      - 104개의 vCPU, 416GiB의 램
      - gpu옵션
      - 28th or 42th hddd
    - Snowball Edge - 스토리지 최적화
      - 약 80개의 vCPU, 80GiB의 램 80TB의 스토리지
  - 모든 Snowcone 기기들은 EC2 인스턴스와 람다 함수 실행 가능
    - 람다 함수를 위해 AWS IoT Greengrass 서비스라는 걸 활용
  - 장기 배포 옵션으로 사용 가능
- AWS OpsHub
  - 과거에는 CLI
  - 설치하는 소프트웨어 (고객들의 컴퓨터에)
  - 그래픽 인터페이스를 사용해서 SNOW기기에 연결하고 설정 가능
    - 싱글 또는 클러스터
    - 인스턴스 시작,관리
    - 기기와 매트릭 모니터링
    - 호환되는 AWS 서비스를 기기에서 시작

#### Amazon FSx

- 완전 관리형 서비스로 타사 고성능 파일 시스템을 실행

- EX_ RDS에서 MYSQL이나 Postgre를 실행하는 것과 같은 개념

- FSx for Lustre

  - 리눅스랑 클러스터를 합친 단어
  - 머신러닝 High Performance Computing

- FSx for Windows File Server

  - 완전 관리형 Windows 파일 서버 공유 드라이브
  - SMB프로토콜과 Windows NTFS를 지원
  - 또한 Microsoft Active Directory 통합 지원
  - EC2 인스턴스에도 마운트 가능
  - Microsoft 분산 파일 시스템인 DFS 기능을 이용해서 파일 시스템을 그룹화 가능
  - 초당 수십 GB에 수백만 IOPS 수백 PB 데이터까지 확장가능
  - 스토리지 옵션
    - SSD
      -  지연시간이 짧아야하는 워크로드를 저장 가능
      - 데이터베이스,미디어 처리, 데이터 분석 등
    - HDD
      - 비용 저렴, 넓은 스펙트럼의 워크로드를 저장

- FSx for NetApp ONTAP

  - NFS,SMB와 호환
  - 다양한 운영체제에서 사용 가능
  - 호환 가능한 폭이 넓음
  - 자동으로 스케일링
  - 복제와 스냅샷 가능
  - 비용 적음 데이터 압축 가능
  - 지정 시간 복제 기능 있음

- FSx for OpenZFS

  - AWS 관리형 OpenZFS파일 시스템

    nfs프로토콜 호환

  - 여러데서 os 호환

  - 스냅샷 압축 지원 비용이 적지만 데이터 중복제거 기능 x

  - 지정 시간 동시 복제 기능 이씀

- FSx 파일 시스템 배포 옵션
  - 스크래치 파일스스템
    - 임시스토리지로 데이터가 복제 x
    - 오작동하면 파일이 모두 유실
    - 성능 높음
    - 단기 처리 데이터에 쓰임
    - 비용 최적화
  - 영구 파일 시스템
    - 장기스토리지
    - 동일한 가용 영역에 데이터가 복제
    - 오작동시 해당파일이 유지
    - 민감한 데이터에서 사용

#### Storage Gateway

- 하이브리드 클라우드
  - 일부 인프라는 AWS 클라우드에 있고 나머지는 그대로 두는것
- AWS Storage Gateway가 S3와 온프레미스 인프라를 이어주는 가교 역할
- AWS 스토리지 클라우드 네이티브 옵션
  - 블록스토리비
  - 파일시스템
  - 객체 수준 스토리지
- 사용사례
  - 재해복구
  - 백업과 복구
  - 온프레미스 캐시로 사용
- 타입
  - S3 파일 게이트웨이
    - Amazon S3 버킷을 사용
    - NFS OR SMB 프로토콜로 함
    - 수명주기 정책을 원하면 S3 Glacier사용 가능
  - FSx file 게이트웨이
    - Windows File Server에 네이티브 액세스를 제공
    - 자주 액세스하는 대이터를 로컬 캐시화 시킬수 있다
  - Volume 게이트웨이
    - 블록스토리지 
    - 볼륨이 ebs 스냅샷으로 저장
    - 캐시볼륨, 저장볼륨 존재
  - 테이프 게이트웨이
    - 물리적으로 테이프를  사용하는 백업 시스템이 있는 회사가 백업에 테이프 대신에 클라우드를 활용
    - 벤더
  - 회사 데이터 센터 내에서 운영해야만함
  - 게이트웨어가 없는 경우 AWS 하드웨어 사용
    - Storage 게이트웨어 : 하드웨어 어플라이언스
    - amazon.com에서 주문 가능
    - 물리적으로설치

#### AWS 전송 제품군

- FTP 프로토콜만 사용하려는 경우에 사용
- 3가지 프로토콜
  - FTP
  - FTPS
  - SFTP
- 완전 관리형 인프라, 확장성 안정상 높음
- 사용자 자격관리 가능

#### DataSync

- 데이터를 동기화
  - 이를 통해 대용량의 데이터를 옮길 수 있다
  - NFS,SMB,HDFS 또는 다른 프로토콜에 연결 해야함
  - AWS서비스에서 다른 AWS서비스로 옮길수 있습
- 동기화 가능
  - S3
  - EFS
  - FSx
- 복제작업은 지정하면 매일,매시간,매주 할수있다
- 파일권한과 메타데이터 저장 기능이 유
- 파일을 한 곳에서 다른 곳으로 옮길 때 이를 이용하여 파일의 메타데이터를 보존 가능

### 5. 디커플링 애플리케이션



