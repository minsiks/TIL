# 24/7/18 AWS SAA(Solutions Architect Associate) - Day07

## 디커플링 애플리케이션

### 1. 디커플링 애플리케이션

- 동기 커뮤니케이션
- 비동기 / 이벤트 베이스

### SQS

- 대기열 (Queue)

### Amazon SQS - Standard Queue

- 가장 오래된 서비스 (10년 넘음)
- 완전 관리 형 서비스, 분리 애플리케이스
- 무제한 처리량을 얻을 수이씀
- 처리량 제한없음
- 메시지 최소 4일 최대 14일 보존
- 게시 및 수신 10초이내
- sqs 작아야함 256kb
- 중복메시지가 있을 수 있음
- 최선의 오더라는 품절메시지를 보낼 수 있음

- 메시지 생산자
  - SDK를 이용해 보냄 (SendMessage API)
  - 소비자가 메시지를 읽고 삭제할 때까지 SQS 대기열에 유지
  - 패킷 오더같은 데에 사용
    - Order id
    - customer id
- 메시지 소비자
  - 일부 코드로 작성
  - EC2인스턴스에서 실행 가능, 온프레스미서버, Lambda
  - 대기열에는 소비가가 있고 소비자는 SQS 메시지를 폴링(한번에 최대 10개)
  - 응답을 보내야함
  - DeleteMessage API로 삭제
- 다중 Ec2 소비자
  - 각 소비자는 각 폴링해 
  - 적어도 한번은 전송
  - 최선의 노력으로 메시지 순서 지정
  - 메시지ㅣ 삭제
  - 수평확장을 하여 처리량 개선
- SQS 오토 스케일링
  - 지표 : 대기열의 길이 
- SQS 보안
  - 암호화 
    - HTTPS
    - KMS
    - 클라이언트측 암호화
  - IAM 정책 액세스 제어
  - SQ3버캣 비슷한 SQS 접근 정책

#### 메시지 가시성 시간 초과

- 소비자가 메시지를 폴링하면 다른 소비자가 안보임
- 가시성 시간초과는 30초
- 그시간내에 다른 요청이 들어와도 메시지 반환 안함
- 메시지가 반환되지 않으면 다시 큐에 넣음
- 가시성 초과내에 안하면 두번 메시지가 처리 될 수도 있음
- 메시지를 처리하지 않아 가시성 시간 초과 기간을 벗어날 때를 위해 ChangeMessageVisbility가 있음

### SQS - Long Polling

- 대기열에 메시지가 업슨데 오래 기다리고 있는것을 롱폴링
- 롱 폴링은 SQS로의 API 호출 숫자를 줄입니다.
- 애플리케이션의 효율성과 대기 시간을 증가
- 1초부터 20초까지

#### SQS - FIFO Queue

- 선입선출
- 대리량 처리에 제한이 있음 초당 3000개
- 중복을 제거해주는 것 때문에 정확히 한개만 호출
- 처리량 제한도 가능

#### SQS 오토 스케일링 그룹

- SQS에서 버퍼 사용
- 분리나 급격히 증가한 로드 혹은 시간초과 등의 문제 신속한 오토스케일링이 필요

#### Amazon SNS

- pub/sub
- 이벤트생성자는sns주제한테만 보냄
- 이벤트 수신자 또는 구독자는 sns알림을 받으려는 사람
- sns주제 구독자는 해당 주제에ㅔ대해서만 필터링
- 구독자 수 1200만 이상
- 주제 10만개
- Sdk 주제 게시
  - 하나 주제
  - 하나 또는 여러개의 구독
  - 주게 게시
- 모바일 앱 SDK
  - 플랫폼 애플리케이션
  - 플랫폼ㅁ 엔드포인트
  - 배포
- 보안
  - HTTPS
  - KMS
  - 클라이언트 
- 액세스 제어 IAM
- 액세스 정책

#### 안

1. daterange 1시간 줄이고

2. 없는 애들 체크 및 배치 전송(하루or한시간) 한달기준

   1. 주기적으로 안보낸 애들의 min, max
   2. 판정 전송이 끝난애가 아닐때 (count>0)
   3. 시간의 min,max => max-min =최대하루

   

3. 테이블 한개 (central)

   1. 실시간

      1. ai insert
      2. operator update
      3. operator 이미지 테이블update시 없으면 이미지 테이블 skip temp upsert
      4. update할때 operator_insp_date 시간비교 temp테이블 이미지 테이블 update 여부 o,x

   2. ai 이미지테이블 insert

   3. opt 

   4. cell 정보 테이블 있으면 skip, insert

      
