# 24/7/10 AWS SAA(Solutions Architect Associate) - Day02

## 고가용성 및 확장성

### 1.고가용성 및 확장성 : ELB, ASG

#### 애플리케이션 로드 밸런서

- 7계층 (http) 전용 로드 밸런서

- 머신간 다수 http 애플리케이션 라우팅
- 동일 EC2 인스턴스 상의 여러 애플리케이션에 부하를 분산(ex: containers)
- http/2 and websocket지원
- 리다이렉트 지원
- 대상 경로 라우팅 지원
  - URL 대상 경로에 기반한 라우팅 가능 (example.com/**users** & example.com/**posts**)
  - URL 호스트 이름에 기반한 라우팅 가능 (one.example.com & other.example.com)
  - 쿼리 문자열가 헤더에 기반한 라우팅 가능 (example.com/user?id=123&order=false)
- ALB : 애플리케이션 로드밸런서 약자 (ex_Docker & Amazon ECS)

- 포트 매핑 기능이 있다
- 클래식 로드 밸런스는 여러개의 로드밸런서가 애플리케이션에 필요
- 반면에 alb는 1개

- 애플리케이션 로드 밸런서 타겟 그룹
  - EC2 instances (오토 스케일링 그룹에 의해 관리 가능) - HTTP
  - ECS tasks (ECS itself가 관리) - HTTP
  - Lambda functions 
  - IP Addresses - 사설 ip여야만함
- ALB 는 여러개의 대상 그룹으로 라우팅 가능
- 상태 확인은 대상그룹레벨에서 확인
- 애플리케이션 서버는 클라이언트의 ip를 직접 보지 x
  - 클라이언트의 실제 ip는 X-Fowarded-For 라고 불리는 헤더에 삽입
  - X-Forwarded-Port나 X-Forwarded-Proto도 얻을 수 있다

####  네트워크 로드 밸런서

- 4계층 (TCP & UDP) 전용 로드밸런서
  - 성능이 매우 높음
  - 시간단 백만건의 요청도 핸들링 가능
  - 지연시간도 짧음 (~100 ms (vs 400ms for ALB))

- NLB는 가용 영역별로 하나의 고정 IP가짐 (탄력적 IP 주소를 각 AZ에 할당 가능)
- 키워드 : 고성능, TCP, UDP, 정적 IP
- AWS 프리티어 X

- NLB 타겟 그룹
  - EC2 인스턴스
  - IP 주소 -프리이빗 아이피
  - ALB
  - TCP,HTTP,HTTPS 프로토콜 상태확인을 지원

#### 게이트웨이 로드 밸런서 (GWLB)

- 배포 및 확장 , AWS의 타사 네트워크 가상 어프랄이언스의 플릿 관리
- 모든 트래픽이 방화벽을 통과하거나 침입 탐지 및 방지 시스템에 사용
  - IDPS, 심층 패킷 분석 시스템, 일부 페이로드를 수정가능
- IP패킷의 네트워크 계층인 L3 전용 로드밸런서
- 기능
  - 투명 네트워크 게이트 웨이
    - 트래픽이 단일 엔트리와 출구를 통과하기 때문
  - 대상그룹의 가상 어플리언스 집합에 전반적으로 그 트래픽을 분산해 로드 밸런서가 됌
- 시험볼 때 6081번 포트의  GENEVE 프로토콜을 사용

- GWLB 타겟그룹
  - EC2 instances
  - IP Addresses - 사설 IP

#### ELB 고정 세션(세션 밀접성)

- 고정성 혹은 고정 세션을 실행하는 것
- 개념 : 로드 밸런서에 2가지 요청을 수행하는 클라이언트가 요청에 응답하기 위해 백엔드에 동일한 인스턴스를 갖는 것
- CLB 또는 ALB 둘다 가능
- 쿠키는 클라이언트에서 로드 밸런서로 요청의 일부로서 전송 되는 것
  - 고정성과 만료기간이 존재
- 사용 사례 : 사용자의 로그인과 같이 중요한 정보를 취하는 세션 데이터를 잃지 않기위해
- 고정성을 활성화 하면 백엔드 EC2 인스턴스 부하에 불균형을 초래
- 일부 인스턴스는 고정 사용자를 가짐
- 쿠키
  - 애플리케이션 기반 쿠키
    - Custom cookie
      - 대상으로 생성된 사용자 정의 쿠키
      - 모든 사용자 정의 속성을 포함 가능
      - 쿠키이름은 각 대상 그룹별로 개별적으로 지정
      - AWSALB,AWSALBAPP,AWSALBTG 등 과같은 이름 사용 X
    - Application cookie
      - 로드 밸런서 자체에서 생성
      - 쿠키이름 : AWSALBAPP
  - 기간 기반 쿠키
    - 로드 밸런서에서 생성되는 쿠키
    - ALB에서는 이름이 AWSALB, CLB 에서 AWSELB
    - 특정 기간을 기반으로 만료,
    - 그 기간이 로드 밸런서 자체에서 생성

#### 크로스존 로드밸런싱 (교차 영역 로드 밸런싱)

- 모든 가용 영역의 모든 인스턴스에 부하를 고르게 분해 

- ALB
  - 교차 영역 로드 밸런싱이 기본으로 활성화
  - 데이터를 다른 가용 영역으로 옮기는데 비용이 없음
    - 일반적으로는 비용을 지불
- NLB, GWLB
  - 기본적으로 교차영역 밸런싱 비활성화
  - 가용영역간의 데이터 활성화 하려면 비용 지불

- CLB (클래식 로드 밸런서)
  - 기본적으로 교차영역 밸런싱 비활성화
  - AZ 간 데이터 이동에 비용이 X

#### SSL/TLS

- SSL 인증서는 클라이언트와 로드 밸런서 사이에서 트래픽이 이동하는동안 암호화 (in-flight encryption)
- SSL : 보안 소켓 계층 - 연결을 암호화 하는데 사용
- TLS : 새로운 버전의 SSL '전송 계층 보안'
- 최근에는 TLS 인증서가 주로 사용
- 퍼블릭 인증서는 인증기관(CA)에서 발급
- 퍼블릭 SSL 인증서를 로드 밸런성 ㅔ추가하면 클라이언트와 로드 밸런서 사이의 연결 암호화

- SSL 인증서에는 만료 날짜가 있어서 주기적으로 갱신해 줘야함
- 사용자가 HTTPS를 통해 접속 -> 로드 밸런서 접속 -. SSL Termination 수행 -> 백엔드엔 HTTP로 EC2 Instance와 통신 
- 로드밸런서는 X.509 인증서 사용, 이걸 SSL 또는 TLS 서버 인증서
- AWS는 이 인증서를 관리할수있는 ACM(AWS Certificate Manager)이 존재
- 원한다면 가진 인증서를 ACM에 업로드 가능
- HTTP 리스너를 구성할 때 반드시 HTTPS 리스너로 해야함
  - 기본 인증서 지정해줘야만 함
  - 다중 도메인을 지원하기 위해 다른 인증서를 추가 필요가능성
  - 클라이언트는 SNI(서버 이름 지정)라는 걸 써서 접속할 호스트의 이름을 알릴 수 있음
  - 원하는 대로 보안정책을 지정 가능 
- SNI
  - 여러개의 SSL 인증서를 하나의 웹 서버에 로드해 하나의 웹서버가 여러개의 웹 사이트 지원 가능 토록
  - 확장된 프로토콜로 클라이언트가 대상 서버의 호스트 이름을 지정하도록
  - 모든 클라이언트가 지원 X 
  - ALB & NLB, CouldFront 만 지원
  - CLB 지원 안함
  - 어떤 로드 밸런서에 SSL 인증서가 여러 개 있다면 ALB나 NLB 둘 중 하나

- 클래식 로드 밸런서
  - ssl 인증서 하나
  - 여러개를 쓰려면 클래식 로드 밸런서 자체를 여러개 둬야함
- ALB, NLB
  - 여러개의 SSL을 지원 가능
  - SNI사용

#### 연결 드레이닝

- 네이밍
  - Connection Draining(연결 드레이닝) - for CLB
  - 등록취소 지연 - for ALB & NLB
- 인스턴스가 등록 취소, 혹은 비정상적인 상태에 있을ㄸ ㅐ 어느정도의 시간을 줘 인-플라이트 요청, 즉 활성 요청을 완료 할 수 있도록 하는 기능
- 인스턴스가 드레이닝 되면 ELB 등록 취ㅣ소 중인 EC2 인스턴스로 새로운 요청 보내지 X
- 연결 드레이닝 파라미터 : 1~3,600초 사이의 값으로 설정(기본적으로 300초)
- 0으로 하면 비활성화
- 짧은 요청의 경우 낮은값으로 설정

#### ASG (Auto Scaling Group)

- 웹사이트나 애플리케이션 배포 시 방문자가 많아지며 로드가 바뀔 가능성
- aws에서 ec2 인스턴스 생성 api 호출을 통해 빠르게 서버를 생성,종료
- 이를 자동화 하고싶으면 asg
- asg 목표
  - 스케일 아웃, 즉 증가한 로드에 맞춰 EC2 인스턴스를 추가
  - 스케일 인, 줄어든 로드에 맞춰 EC2 인스턴스를 제거
  - 시간이 지나며 변함
  - 최소 개수,최대 개수 정할수 있음
  - 로드밸런서와 페어링시 ASG에속한 모든 EC2 인스턴스가 자동으로 등록
  - 한 인스턴스가 비정상이면 종료하고 자동으로 생성
- ASG는 Free/ EC2 인스턴스와 같은, 생성된 하위 리소스에 대한 비용만 지불

- 인스턴스 속성 기반
  - 생성 시 A Launch Template 으로
    - AMI + Instance Type
    - EC2 User Data
    - EBS Volumes
    - Security Groups
    - SSH Key pair
    - IAM Roles for EC2 instances
    - Network + subnet Info
    - Load Balncer Info
  - 최소/ 최대 사이즈, 초기용량 정의
  - 스케일링 정책

- CloudWatch 경보(알람)
  - CloudWatch 알람을 기반으로 ASG를 스케일 인 및 스케일 아웃가능
  - Metirc(지표)를 통해 모니터링 (평균 CPU, 사용자 사용지표 등 지정)
  - Ex_ ASG전체의 평균 CPU가 너무 높으면 EC2 추가 필요 -> 지표에 따라 경보 울리고 -> 스케일링 활동 유발
  - 경보를 기반 스케일 수를 늘리거나 스케일 인 정책을 만듬

#### 오토 스케일링 - 동적 스케일링 정책

- 대상 추적 스케일링
  - 가장 단순 설정하기 쉬움
  - ex_ 모든 EC2 인스턴스의 오토스케일링 그룹의 평균 CPU 사용률을 추적하여 40%대에 머무를수있도록

- 단순/ 단계 스케줄링
  - cloudwatch 경보 설정 
  - ex_ 
    - 전체 asg에 대한 cpu 사용률이 70%를 초과하는 경우 2개로 추가
    - cpu 사용률이 30% 이하로 떨어지면 유닛 하나를 제거

- 예약된 작업
  - 나와 있는 사용 패턴을 바탕으로 스케일링을 예상
  - ex_ 금요일 오후에 큰 이벤트가 예정-> asg 최소 용량을 자동으로 금요일마다 올림
  - 예측 스케일링 : 로드를 문석, 다음 스케줄링을 예측

- 스케일링을 위한 지표
  - CPU 사용률 : 평균 CPU 사용률
  - 대상별 요청의 수: 한번에 대서아별로 1000개의 요청만
  - 평균 네트워크 입출력양
  - 아무 Custom 지표

- 스케일링 쿨다운(휴지)

  - 스케일링 작업이 끝날 때마다 인스턴스의 추가 또는 삭제를 막론하고 기본적으로 5분 혹은 300초의 휴지기간을 가짐
  - 휴지 기간에는 ASG가 추가 인스턴스를 실행 또는 종료 X
  - 준비된 ami를 사용하여 ec2인스턴스 구성시간을 단축 이를 통해 요청을 추천

- 

  

